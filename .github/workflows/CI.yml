name: CI
on: [pull_request]

jobs:
  build:
    runs-on: ubuntu-latest

    permissions:
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8

      - name: ğŸ”§ Setup tools (mise)
        uses: jdx/mise-action@bf7ce94bf71e42b9b3bb1350675aac847b7388c4
        with:
          cache: true
          experimental: true

      - name: Restore Rust cache
        uses: Swatinem/rust-cache@5e4a76743357a1c3c57315bc1896d2c7f89d6861

      - name: Run tests
        run: mise test

      - name: Comment test success
        if: success()
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd
        with:
          script: |
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: "ğŸ‰ **All unit tests passed!** âœ…"
            })

      - name: Comment test failure
        if: failure()
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd
        with:
          script: |
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: "ğŸ’¥ **Unit tests failed. Please check the CI logs.** âŒ"
            })
